<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>按需加载器</title>
</head>
<body>
	<h2>加载队列</h2>
	<a href="javascript:;" id="one">点击我1</a>
	<a href="javascript:;" id="two">点击我2</a>
	<script>
		/*author:pingfan ,date:2014-12-04
		  按需加载库，本库是顺序加载，不涉及并行加载  
		  主体方法LoadQueue，接收参数opt，对应两个属性manifest加载资源，version版本号
		*/

		;(function(window,undefined){

			//封装绑定事件机制
		    var EventUtil={
                addHandler:function(element,type,handler){
                        if(element.addEventListener){
                                element.addEventListener(type,handler,false);
                        }else if(element.attachEvent){
                                element.attachEvent("on"+type,handler);
                        }else{
                                element["on"+type]=handler;
                        }
                },
                removeHandler:function(element,type,handler){
                        if(element.removeEventListener){
                                element.removeEventListener(type,handler,false);
                        }else if(element.detachEvent){
                                element.detachEvent('on'+type,handler);
                        }else{
                                element["on"+type]=null;
                        }
                }
            }
                
			function LoadQueue(opt){
				this.list=opt.manifest || [],
				this.version=opt.version,
				this.loadsuccess=false;
			}

			LoadQueue.prototype={
				constructor:LoadQueue,
				isType:function(src){

					/*通过正则匹配加载资源的类型，img，script，css，audio
					  匹配都不区分大小写，因为扩展名大写浏览器也可访问到	*/
					var resImg=/.*\.jpg|png|gif|bmp(?=\?|$)/i,
						resJs=/.*\.js(?=\?|$)/i,
						resCss=/.*\.css(?=\?|$)/i,
						resSound=/.*\.mp3|m4a|ogg|wav|wma(?=\?|$)/i;
					if(resImg.test(src)) return "img";	
					if(resJs.test(src)) return "js";	
					if(resCss.test(src)) return "css";	
					if(resSound.test(src)) return "audio";	
				},

				/*由于load事件在ie8及以下，对标签<script>,<link>,不支持，下面通用的对css，js监测加载成功
				 对接参数type为类型css或者js，src为路径，callback为加载成功或不成功的回调函数*/
				loadCssJS:function(type,src,callback){
					var source,_this=this;
		   			if(type == "css"){
		   				source = document.createElement("link");
		   				source.setAttribute("rel","stylesheet")
		   				source.setAttribute("type","text/css");
		   			}else if(type == "js"){
		   				source = document.createElement('script');
		   				source.setAttribute("type","text/javascript");
		   			}

					//因为有的浏览器既支持load事件和，readystatechange事件，这里用了if else所以防止出现两次，js，css监测，ie8及更早不支持<javascript>标签的load事件
			        if (source.readyState){  //IE
			            EventUtil.addHandler(source,"readystatechange",function(){
			                if (source.readyState == "loaded" || source.readyState == "complete"){
			                    source.onreadystatechange = null;
			                    callback && callback.call(_this);
			                }
						});
						EventUtil.addHandler(source,"error",function(){
							 callback && callback.call(_this);
						});
			        } else {  //Others
		            	EventUtil.addHandler(source,"load",function(){
							 callback && callback.call(_this);
						});
						EventUtil.addHandler(source,"error",function(){
							 callback && callback.call(_this);
						});
			        }

			        //追加节点到头部
					(type == "css") && (source.setAttribute("href", src));
					(type == "js") && (source.setAttribute("src", src));			
				   	document.getElementsByTagName('head')[0].appendChild(source); 	 			        
				},

				/*getResult是获取加载成功的资源,这里只能获取加载成功的img，audio资源，js和css是直接加到<head>标签的不能获取操作，传入参数id即为manifest里面对应的属性*/
				getResult:function(id){
					//当没有加载成功启动此方法，直接返回null
					if(!this.loadsuccess) return null; 
					for(var i=0,len=this.list.length;i<len;i++){
						if(this.list[i].id == id){
							var returnSrc=this.list[i].src;
							if(this.isType(returnSrc) == "img"){
								var img = new Image();
								img.src=returnSrc;
								return img;
							}else if(this.isType(returnSrc) == "audio"){
								var audio = new Audio();
								audio.src=returnSrc;
								return audio;
							}else{
								alert("此类型没有返回资源操作");
							}
						}
					}
				},

				/*加载执行函数*/
				done:function(){
					//如果导入资源为空则直接返回,fasle对应0,1为ture则可以采取以下判断
					if(!this.list.length) return false;
					var _this=this,len=this.list.length,i=0;
					(function isLoad(i){
						var src=_this.list[i].src;

						//导入的资源不能含有？时间戳和版本号，监测版本号参数是否存在，加版本号
						(_this.version) && (src=src+"?ver="+_this.version);

						//图片资源加载
						if(_this.isType(src) == "img"){
							var img=new Image();
							EventUtil.addHandler(img,"load",function(){
								callNext();
							});
							EventUtil.addHandler(img,"error",function(){
								callNext();
							});
							img.src=src;
						}

						//音频资源加载
						if(_this.isType(src) == "audio"){
							var audio=new Audio();
							//音频audio用使用canplaythrough来监测是否加载成功
							EventUtil.addHandler(audio,"canplaythrough",function(){
								callNext();
							});
							EventUtil.addHandler(audio,"error",function(){
								callNext();
							});
							audio.src=src;
						}

						//脚本资源加载
						if(_this.isType(src) == "js"){
							_this.loadCssJS("js",src,callNext)
						}

						//样式资源加载
						if(_this.isType(src) == "css"){
							_this.loadCssJS("css",src,callNext)
						}

						//单个资源加载成功后的回调函数
						function callNext(){
							i++;
							if(i<len){
								isLoad(i);
							}else{
								_this.loadsuccess=true;
								_this.LoadSuccess();
							}
						}
					})(i)
				},

				/*加载成功函数*/
				LoadSuccess:function(callback){
					callback && callback.call(this);
				}
			}
			window.LoadQueue=LoadQueue;
		})(window)

		//使用方式
		var manifest=[
			{src:'img/big.jpg',id:"big"},
			{src:'img/112.jpg',id:"twee"},
			{src:'img/img_09.JPG',id:"one"},
			{src:'img/img_02.jpg',id:"two11"},
			{src:'img/img_03.jpg',id:"three"},
			{src:'img/img_04.jpg',id:"four"},
			{src:'js/zepto.js',id:"zepto"},
			{src:'css/game.css',id:"css"},
			{src:'img/0.m4a',id:"sound"}
		];

		var loadqueue=new LoadQueue({
			manifest:manifest,
			version:"1.3.0"
		});
		loadqueue.done();
		loadqueue.LoadSuccess=function(){
			alert("你大爷的另一个加载成功   "+$("#one").text());	
			var audio=loadqueue.getResult("sound");
			audio.play();
			audio.loop=true;
			var img=loadqueue.getResult("big");
			console.log(img);
		}
	</script>
</body>
</html>